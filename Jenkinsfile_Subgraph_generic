@Library('global-jenkins-library@2.7.7') _

def userInput

node {
    docker.image('node:18').inside('--user root') {
        stage('Setup') {
            checkout scm
        }
        stage('Deployment form') {
            timeout(time: 5, unit: 'MINUTES') {
                userInput = input(
                    id: 'select-deployment',
                    message: 'Select environment & service',
                    parameters: [
                        string(name: 'network', description: 'The network name you want to deploy your subgraph'),
                        string(name: 'targetRemoteHost', description: 'The host you want to deploy the subgraph'),
                    ]
                )
            }
            println "Selected network: '${userInput.network}'"
            println "Selected service name: '${userInput.targetRemoteHost}'"
        }
        stage('Setup Docker image') {
            sh 'apt install bash'
        }
        stage('Building subgraph') {
            // Print working directory and list files for debugging
            sh """
            cd /home/ubuntu/jenkins/workspace/graph_Poco_Gen_feat_subgraph_c13 && 
            ls -la &&
            chmod +x generate_subgraph.sh &&
            cat generate_subgraph.sh &&
            apk add bash &&
            bash ./generate_subgraph.sh '${userInput.network}'
            """
            
            // Check if the subgraph file was generated
            sh """
            FILE=/home/ubuntu/jenkins/workspace/graph_Poco_Gen_feat_subgraph_c13/subgraph.${userInput.network}.yaml
            if test -f "\$FILE"; then
                echo "Subgraph file generated successfully"
            else
                echo "Failed to generate subgraph file"
                exit 1
            fi
            """
        }
        stage('Deploy SubGraph') {
            deploySubGraph(
                targetRemoteHost: "${userInput.targetRemoteHost}",
                subgraphFolder: './',
                subgraphFilename: "subgraph.${userInput.network}.yaml",
                subgraphVersionLabel: 'v1.0.0-rc.1',
                subgraphLabel: "${userInput.network}/poco-v5"
            )
        }
    }
}
